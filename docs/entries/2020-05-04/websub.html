<!DOCTYPE html><html lang="ja"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>PubSubHubbub について | blog.comame.xyz</title><meta property="og:type" content="article"/><meta property="og:url" content="https://blog.comame.xyz/entries/2020-05-04/websub.md"/><meta property="og:title" content="PubSubHubbub について | blog.comame.xyz"/><meta property="og:site_name" content="blog.comame.xyz"/><meta property="og:description" content=""/><meta name="description" content=""/><meta name="next-head-count" content="9"/><link rel="preload" href="/_next/static/css/75b3a985ae8df8a5857d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/75b3a985ae8df8a5857d.css"/><link rel="preload" href="/_next/static/css/7e552a05a23ef38b9280.css" as="style"/><link rel="stylesheet" href="/_next/static/css/7e552a05a23ef38b9280.css"/><link rel="preload" href="/_next/static/chunks/main-f01cf1dcca173d7f43b1.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-ccf5ab034a524403276a.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.ea5d6f7a7099b14097ba.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.136473f176143783e714.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-7826aa35c5692e1bca69.js" as="script"/><link rel="preload" href="/_next/static/chunks/44192d0b83adb4471c56c08528820b1f17270e33.228b4631e982fe3bd0c5.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/entries/%5Bdate%5D/%5Bid%5D-217160f5fe64bb279c4b.js" as="script"/></head><body><div id="__next"><header class="header_header__10AWY"><a href="/">blog.comame.xyz</a></header><div class="post"><div class="metadata_metadata__3aUvp"><h1 id="title">PubSubHubbub について</h1><time id="time">2020-05-04</time><ul class="tag-list_tag-list__1Wf57"><li><a href="/tags/Web.html">Web</a></li></ul></div><div class="content_content__3lhGG"><p>この記事は、<a href=https://pubsubhubbub.appspot.com target='_blank' rel='noopener'>pubsubhubbub.appspot.com</a> で Subscribe した時の挙動について書く。</p>
<p>pubsubhubbub.appspot.com は <a href=https://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.4.html target='_blank' rel='noopener'>PubSubHubbub Core 0.4</a> と Permanent subscriptions を除く <a href=https://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.3.html target='_blank' rel='noopener'>PubSubHubbub Core 0.3</a> に従っている。</p>
<p>PubSubHubbub とは、Subscriber 側から見た場合は Webhook である。現在は W3C によって <a href=https://w3c.github.io/websub/ target='_blank' rel='noopener'>WebSub</a> として公開されている。WebSub は PubSubHubbub Core 0.4 と概ね同じだと思われる (あまり読み込んでいない)。</p>
<h2>PubSubHubbub Core 0.4</h2>
<p>仕様を正確に翻訳したものではない。実装する際には元の仕様を参照することをおすすめする。</p>
<h3>用語</h3>
<dl>
    <dt>Topic</dt>
    <dd>HTTP の URL。変更を購読するリソースを一意に表す。</dd>
    <dt>Hub</dt>
    <dd>PubSubHubbub の Subscribing と Publishing をどちらも実装するサーバ。</dd>
    <dt>Subscriber</dt>
    <dd>Topic の更新を受け取るエンティティ。</dd>
    <dt>Subscription</dt>
    <dd>Topic とその更新通知を受け取る Subscriber の一意な関係。Topic URL と Subscriber Callback URL をキーとする。</dd>
    <dt>Subscriber Callback URL</dt>
    <dd>Subscriber が通知を受け取る URL。</dd>
</dl>

<p>参照: <a href=https://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.4.html#rfc.section.2 target='_blank' rel='noopener'>2. Definitions</a></p>
<h3>Subscribing</h3>
<p>購読を登録するとき、次のような流れとなる。</p>
<ol>
<li>Subscriber が Hub に Subscription Request を送信する</li>
<li>Hub が Subscription Request を検証する (OPTIONAL)</li>
<li>Hub が Subscriber に Verificatin Request を送信する</li>
<li>Subscriber が Hub に Verification Response を返す</li>
</ol>
<p>参照: <a href=https://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.4.html#rfc.section.5 target='_blank' rel='noopener'>5. Subscribing and Unsubscribing</a></p>
<h3>Subscription Request</h3>
<p>以下のパラメータを <code>Content-Type: application/x-www-form-urlencoded</code> で POST する。</p>
<dl>
    <dt>hub.callback</dt>
    <dd>REQUIRED. Subscriber Callback URL。配信通知はこの URL に対して POST される。クエリパラメータは保持される (<a href='https://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.4.html#rfc.section.5.1.1' rel='noopener' target='_blank'>5.1.1. Subscription Parameter Details</a>)。</dd>
    <dt>hub.mode</dt>
    <dd>REQUIRED. <code>subscribe</code> あるいは <code>unsubscribe</code> のいずれかの値をとる。</dd>
    <dt>hub.topic</dt>
    <dd>REQUIRED. 購読する Topic の URL。</dd>
    <dt>hub.lease_seconds</dt>
    <dd>OPTIONAL. 購読の有効な時間 (秒)。Hub はこの値に従ってもよいし、従わなくともよい。<code>hub.mode</code> が <code>unsubscribe</code> の場合は無視される。</dd>
    <dt>hub.secret</dt>
    <dd>OPTIONAL. 後に Subscriber が更新通知を検証できるようにするための値。詳しくは後述。</dd>
</dl>

<p>既に有効な Subscription がある場合、Hub は Subscription を更新する。Subscription の確認に失敗した場合は、以前の購読状態を継続する。</p>
<p>参照: <a href=https://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.4.html#rfc.section.5.1 target='_blank' rel='noopener'>5.1. Subscriber Sends Subscription Request</a></p>
<h3>Subscription Response</h3>
<p>Hub は HTTP <code>202 Accepted</code> によって、Subscription Request が検証され、確認されることを示す。エラーが発生した場合、Hub は 4xx または 5xx を返す。</p>
<p>参照: <a href=https://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.4.html#rfc.section.5.1.2 target='_blank' rel='noopener'>5.1.2. Subscription Response Details</a></p>
<h3>Verification Request</h3>
<p>Subscription Request が正しいものかを確認するため、Hub は Subscriber Callback URL に以下のクエリパラメータとともに GET リクエストを送信する。</p>
<dl>
    <dt>hub.mode</dt>
    <dd>REQUIRED. Subscription Request に指定した値と同じ値を示す。</dd>
    <dt>hub.topic</dt>
    <dd>REQUIRED. Subscription Request に指定した値と同じ値を示す。</dd>
    <dt>hub.challenge</dt>
    <dd>REQUIRED. Hub によって生成されたランダムな文字列。Subscriber はこの値をレスポンスとして返すことにより、Subscription を確認する。</dd>
    <dt>hub.lease_seconds</dt>
    <dd>REQUIRED/OPTIONAL. <code>hub.mode</code> が <code>subscribe</code> の場合、REQUIRED となる。Hub によって決定された購読の有効な時間 (秒) を表す。</dd>
</dl>

<p>参照: <a href=https://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.4.html#rfc.section.5.3 target='_blank' rel='noopener'>5.3. Hub Verifies Intent of the Subscriber</a></p>
<p>リクエストされた内容が正しい場合、Subscriber は <code>hub.challenge</code> の値をレスポンスボディに含め、2xx を返す。リクエストされた内容が正しくない場合、Subscriber は 404 を返す。</p>
<p>その他のステータスコードを返した場合、またはレスポンスボディが <code>hub.challenge</code> の値と異なる場合、確認は失敗する。</p>
<p>参照: <a href=https://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.4.html#rfc.section.5.3.1 target='_blank' rel='noopener'>5.3.1. Verification Details</a></p>
<h3>更新の通知</h3>
<p>コンテンツが更新された時、Hub は Subscriber Callback URL に POST リクエストを送信する。</p>
<p>リクエストを受け取ったとき、Subscriber は 2xx を返さなければならない。それ以外のステータスコードを返した場合、通知は失敗したとみなされる (リダイレクトも機能しない)。2xx のレスポンスはあくまで正常に通知を受け取ったことを表すのみであり、通知の内容が正しいことを示すものではない。</p>
<p>リクエストには、RFC5988 に規定される <a href=https://tools.ietf.org/html/rfc5988 target='_blank' rel='noopener'>Link Header</a> が付与される。<code>rel=hub</code> には Hub の URL を、<code>rel=self</code> には Topic の URL が指定される。</p>
<p>参照: <a href=https://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.4.html#contentdistribution target='_blank' rel='noopener'>7. Content Distribution</a></p>
<h3>検証可能な更新の通知</h3>
<p>Subscription Request に <code>hub.secret</code> を含めた場合、Hub はペイロードの HMAC 署名をヘッダに付与する。署名は 40 バイトの 16 進数表示の SHA-1 である。ヘッダの形式は次のようになる。</p>
<pre>
<code>X-Hub-Signature: sha1=<signature></code>
</pre><p>これにより、通知の内容が第三者に偽造されたものではないことを確認できる。</p>
<p><a href=https://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.4.html#authednotify target='_blank' rel='noopener'>8. Authenticated Content Distribution</a></p>
<h2>PubSubHubbub Core 0.3 による追加事項</h2>
<h3>メッセージの形式</h3>
<p>更新の通知は <a href=https://tools.ietf.org/html/rfc4287 target='_blank' rel='noopener'>Atom</a> あるいは <a href=https://www.rssboard.org/rss-specification target='_blank' rel='noopener'>RSS</a> の形式である。</p>
<p>参照: <a href=https://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.3.html#anchor4 target='_blank' rel='noopener'>4.  Atom Details</a></p>
<h3>Subscription Request</h3>
<p>以下のパラメータが追加される。</p>
<dl>
    <dt>hub.verify</dt>
    <dd>REQUIRED. Subscriber が Subscription を確認する方法を指定する。<code>sync</code> あるいは <code>async</code> のいずれの値をとる。</dd>
    <dt>hub.verify_token</dt>
    <dd>OPTIONAL. 指定した場合、Hub はこの値を Verification Request のクエリパラメータに付与する。</dd>
</dl>

<p>参考: <a href=https://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.3.html#anchor5 target='_blank' rel='noopener'>6.1.  Subscriber Sends Subscription Request</a></p>
<h3>Verification Request</h3>
<p>以下のクエリパラメータが追加される。</p>
<dl>
    <dt>hub.verify_token</dt>
    <dd>OPTIONAL. Subscription Request に指定した値をそのまま含む。</dd>
</dl>

<p>以下のパラメータが変更される。</p>
<dl>
    <dt>hub.lease_seconds</dt>
    <dd>OPTIONAL/REQUIRED. 値が含まれていた場合の挙動は PubSubHubbub Core 0.4 と同一である。値が含まれない場合、後述するように Subscription の更新の挙動が変わる。</dd>
</dl>

<p>参照: <a href=https://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.3.html#verifysub target='_blank' rel='noopener'>6.2.  Hub Verifies Intent of the Subscriber</a></p>
<h3>自動的な Subscription の更新</h3>
<p>注意: pubsubhubbub.appspot.com では非対応である。</p>
<p><code>hub.lease_seconds</code> が経過する前に、Hub は自動的に Subscription の確認を行う。</p>
<p>参照: <a href=https://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.3.html#autorefresh target='_blank' rel='noopener'>6.3 Automatic Subscription Refresh</a></p>
<h2>pubsubhubbub.appspot.com の挙動</h2>
<p>筆者が自分の環境で確認したものである。仕様に定められた挙動ではないため、将来的に変更される可能性もある。</p>
<h3>Subscription Request の宛先</h3>
<p>送信先は <code>https://pubsubhubbub.appspot.com/subscribe</code> である。</p>
<h3>Subscription Response のステータスコード</h3>
<p><code>hub.verify</code> が <code>sync</code> の場合、正常に Subscription Request が受理されたときは 204 No Content を返す。</p>
<h3>Permanent Subscription の非対応</h3>
<p>PubSubHubbub Core 0.3 の 6.3 Automatic Subscription Refresh には対応しない。Subscriber は hub.lease_seconds が経過する前に再び Subscription Request を行う必要がある。</p>
<h2>補足・考察</h2>
<p>pubsubhubbub.appspot.com は PubSubHubbub Core 0.4 に加えて PubSubHubbub Core 0.3 も参照するが、Permanent Subscription には非対応であるため、実用上は <code>hub.verify_token</code> が追加されることにだけ注意すれば良いと思われる。大抵の場合は <code>hub.verify</code> を <code>sync</code> として問題ないであろう。</p>
<p>PubSubHubbub Core 0.3 では更新通知のメッセージ形式が Atom または RSS と規定されているが、PubSubHubbub Core 0.4 および WebSub では撤廃されている。これにより、より汎用性の高いプロトコルを目指したと思われる。</p>
<p>また、新しいバージョンでは <code>hub.verify_token</code> も撤廃されている。このプロパティによって Verification Request を検証できるというメリットがあったが、これは Subscriber Callback URL に独自のクエリパラメータを付与することで代替できる。あるいは、第三者によって意図しない Subscription を登録されたとしても、更新通知を処理するかどうかは変わらず Subscriber の判断によるため、仕様から削除されたのかもしれない。</p>
<p>Automatic Subscription Refresh の撤廃は、より簡単な Webhook の登録を目指すという観点からは悪手であろう。一方、PubSubHubbub はそもそも RSS や Atom フィードのリアルタイム化を目指したものであること (<a href=https://ja.wikipedia.org/wiki/WebSub target='_blank' rel='noopener'>Wikipedia</a> を参照のこと) を踏まえれば妥当であるともいえる。もし Subscriber が Subscription の更新を忘れてしまったとしても、最新の更新情報は元のリソースを参照することで簡単に取得できるからである。</p>
<h2>経緯 (余談)</h2>
<p>YouTube Data API v3 について調べていたのだが、Search: list (100 Units/Request) をむやみに叩くとすぐに制限 (10,000 Units/Day) に達してしまう。特定のチャンネルのアップデートを素早く受け取るために、<a href=https://developers.google.com/youtube/v3/guides/push_notifications target='_blank' rel='noopener'>PubSubHubbub をサポート</a>していた。</p>
</div><div class="share_share__2h1cH"><img alt="共有" src="/icons/share.svg"/><a rel="noopener" target="_blank" title="Twitter で共有" href="https://twitter.com/intent/tweet?text=PubSubHubbub%20%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%0a&amp;url=https%3A%2F%2Fblog.comame.xyz%2Fentries%2F2020-05-04%2Fwebsub.md&amp;related=comameito"><img alt="Twitter で共有" src="/icons/twitter_logo.svg"/></a><a rel="noopener" target="_blank" title="Facebook で共有" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fblog.comame.xyz%2Fentries%2F2020-05-04%2Fwebsub.md"><img alt="Facebook で共有" src="/icons/facebook_logo.svg"/></a><a title="URL をコピー" id="url-copy"><img alt="URL をコピー" src="/icons/link.svg"/></a><script async="" src="/js/url-copy.js"></script></div></div><footer class="footer_footer__cDy4s"><small><a href="https://github.com/comame/blog.comame.xyz" target="_blank" rel="noopener"><img alt="GitHub Actions build status" id="build-status" src="https://github.com/comame/blog.comame.xyz/workflows/Build/badge.svg?event=push"/></a></small><small><span>Copyright 2020 <a href="https://comame.xyz">comame</a></span><span><a target="_blank" rel="noopener" href="https://github.com/comame/blog.comame.xyz/blob/master/archives/2020/websub.md">source</a></span><span><a target="_blank" rel="noopener" href="https://github.com/comame/blog.comame.xyz/commits/master/archives/2020/websub.md">history</a></span><span><a href="/feed.xml">Feed</a></span></small></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"entry":{"entry":"websub","title":"PubSubHubbub について","date":"2020-05-04","tags":["Web"],"type":"md"},"text":"\u003cp\u003eこの記事は、\u003ca href=https://pubsubhubbub.appspot.com target='_blank' rel='noopener'\u003epubsubhubbub.appspot.com\u003c/a\u003e で Subscribe した時の挙動について書く。\u003c/p\u003e\n\u003cp\u003epubsubhubbub.appspot.com は \u003ca href=https://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.4.html target='_blank' rel='noopener'\u003ePubSubHubbub Core 0.4\u003c/a\u003e と Permanent subscriptions を除く \u003ca href=https://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.3.html target='_blank' rel='noopener'\u003ePubSubHubbub Core 0.3\u003c/a\u003e に従っている。\u003c/p\u003e\n\u003cp\u003ePubSubHubbub とは、Subscriber 側から見た場合は Webhook である。現在は W3C によって \u003ca href=https://w3c.github.io/websub/ target='_blank' rel='noopener'\u003eWebSub\u003c/a\u003e として公開されている。WebSub は PubSubHubbub Core 0.4 と概ね同じだと思われる (あまり読み込んでいない)。\u003c/p\u003e\n\u003ch2\u003ePubSubHubbub Core 0.4\u003c/h2\u003e\n\u003cp\u003e仕様を正確に翻訳したものではない。実装する際には元の仕様を参照することをおすすめする。\u003c/p\u003e\n\u003ch3\u003e用語\u003c/h3\u003e\n\u003cdl\u003e\n    \u003cdt\u003eTopic\u003c/dt\u003e\n    \u003cdd\u003eHTTP の URL。変更を購読するリソースを一意に表す。\u003c/dd\u003e\n    \u003cdt\u003eHub\u003c/dt\u003e\n    \u003cdd\u003ePubSubHubbub の Subscribing と Publishing をどちらも実装するサーバ。\u003c/dd\u003e\n    \u003cdt\u003eSubscriber\u003c/dt\u003e\n    \u003cdd\u003eTopic の更新を受け取るエンティティ。\u003c/dd\u003e\n    \u003cdt\u003eSubscription\u003c/dt\u003e\n    \u003cdd\u003eTopic とその更新通知を受け取る Subscriber の一意な関係。Topic URL と Subscriber Callback URL をキーとする。\u003c/dd\u003e\n    \u003cdt\u003eSubscriber Callback URL\u003c/dt\u003e\n    \u003cdd\u003eSubscriber が通知を受け取る URL。\u003c/dd\u003e\n\u003c/dl\u003e\n\n\u003cp\u003e参照: \u003ca href=https://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.4.html#rfc.section.2 target='_blank' rel='noopener'\u003e2. Definitions\u003c/a\u003e\u003c/p\u003e\n\u003ch3\u003eSubscribing\u003c/h3\u003e\n\u003cp\u003e購読を登録するとき、次のような流れとなる。\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eSubscriber が Hub に Subscription Request を送信する\u003c/li\u003e\n\u003cli\u003eHub が Subscription Request を検証する (OPTIONAL)\u003c/li\u003e\n\u003cli\u003eHub が Subscriber に Verificatin Request を送信する\u003c/li\u003e\n\u003cli\u003eSubscriber が Hub に Verification Response を返す\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e参照: \u003ca href=https://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.4.html#rfc.section.5 target='_blank' rel='noopener'\u003e5. Subscribing and Unsubscribing\u003c/a\u003e\u003c/p\u003e\n\u003ch3\u003eSubscription Request\u003c/h3\u003e\n\u003cp\u003e以下のパラメータを \u003ccode\u003eContent-Type: application/x-www-form-urlencoded\u003c/code\u003e で POST する。\u003c/p\u003e\n\u003cdl\u003e\n    \u003cdt\u003ehub.callback\u003c/dt\u003e\n    \u003cdd\u003eREQUIRED. Subscriber Callback URL。配信通知はこの URL に対して POST される。クエリパラメータは保持される (\u003ca href='https://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.4.html#rfc.section.5.1.1' rel='noopener' target='_blank'\u003e5.1.1. Subscription Parameter Details\u003c/a\u003e)。\u003c/dd\u003e\n    \u003cdt\u003ehub.mode\u003c/dt\u003e\n    \u003cdd\u003eREQUIRED. \u003ccode\u003esubscribe\u003c/code\u003e あるいは \u003ccode\u003eunsubscribe\u003c/code\u003e のいずれかの値をとる。\u003c/dd\u003e\n    \u003cdt\u003ehub.topic\u003c/dt\u003e\n    \u003cdd\u003eREQUIRED. 購読する Topic の URL。\u003c/dd\u003e\n    \u003cdt\u003ehub.lease_seconds\u003c/dt\u003e\n    \u003cdd\u003eOPTIONAL. 購読の有効な時間 (秒)。Hub はこの値に従ってもよいし、従わなくともよい。\u003ccode\u003ehub.mode\u003c/code\u003e が \u003ccode\u003eunsubscribe\u003c/code\u003e の場合は無視される。\u003c/dd\u003e\n    \u003cdt\u003ehub.secret\u003c/dt\u003e\n    \u003cdd\u003eOPTIONAL. 後に Subscriber が更新通知を検証できるようにするための値。詳しくは後述。\u003c/dd\u003e\n\u003c/dl\u003e\n\n\u003cp\u003e既に有効な Subscription がある場合、Hub は Subscription を更新する。Subscription の確認に失敗した場合は、以前の購読状態を継続する。\u003c/p\u003e\n\u003cp\u003e参照: \u003ca href=https://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.4.html#rfc.section.5.1 target='_blank' rel='noopener'\u003e5.1. Subscriber Sends Subscription Request\u003c/a\u003e\u003c/p\u003e\n\u003ch3\u003eSubscription Response\u003c/h3\u003e\n\u003cp\u003eHub は HTTP \u003ccode\u003e202 Accepted\u003c/code\u003e によって、Subscription Request が検証され、確認されることを示す。エラーが発生した場合、Hub は 4xx または 5xx を返す。\u003c/p\u003e\n\u003cp\u003e参照: \u003ca href=https://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.4.html#rfc.section.5.1.2 target='_blank' rel='noopener'\u003e5.1.2. Subscription Response Details\u003c/a\u003e\u003c/p\u003e\n\u003ch3\u003eVerification Request\u003c/h3\u003e\n\u003cp\u003eSubscription Request が正しいものかを確認するため、Hub は Subscriber Callback URL に以下のクエリパラメータとともに GET リクエストを送信する。\u003c/p\u003e\n\u003cdl\u003e\n    \u003cdt\u003ehub.mode\u003c/dt\u003e\n    \u003cdd\u003eREQUIRED. Subscription Request に指定した値と同じ値を示す。\u003c/dd\u003e\n    \u003cdt\u003ehub.topic\u003c/dt\u003e\n    \u003cdd\u003eREQUIRED. Subscription Request に指定した値と同じ値を示す。\u003c/dd\u003e\n    \u003cdt\u003ehub.challenge\u003c/dt\u003e\n    \u003cdd\u003eREQUIRED. Hub によって生成されたランダムな文字列。Subscriber はこの値をレスポンスとして返すことにより、Subscription を確認する。\u003c/dd\u003e\n    \u003cdt\u003ehub.lease_seconds\u003c/dt\u003e\n    \u003cdd\u003eREQUIRED/OPTIONAL. \u003ccode\u003ehub.mode\u003c/code\u003e が \u003ccode\u003esubscribe\u003c/code\u003e の場合、REQUIRED となる。Hub によって決定された購読の有効な時間 (秒) を表す。\u003c/dd\u003e\n\u003c/dl\u003e\n\n\u003cp\u003e参照: \u003ca href=https://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.4.html#rfc.section.5.3 target='_blank' rel='noopener'\u003e5.3. Hub Verifies Intent of the Subscriber\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eリクエストされた内容が正しい場合、Subscriber は \u003ccode\u003ehub.challenge\u003c/code\u003e の値をレスポンスボディに含め、2xx を返す。リクエストされた内容が正しくない場合、Subscriber は 404 を返す。\u003c/p\u003e\n\u003cp\u003eその他のステータスコードを返した場合、またはレスポンスボディが \u003ccode\u003ehub.challenge\u003c/code\u003e の値と異なる場合、確認は失敗する。\u003c/p\u003e\n\u003cp\u003e参照: \u003ca href=https://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.4.html#rfc.section.5.3.1 target='_blank' rel='noopener'\u003e5.3.1. Verification Details\u003c/a\u003e\u003c/p\u003e\n\u003ch3\u003e更新の通知\u003c/h3\u003e\n\u003cp\u003eコンテンツが更新された時、Hub は Subscriber Callback URL に POST リクエストを送信する。\u003c/p\u003e\n\u003cp\u003eリクエストを受け取ったとき、Subscriber は 2xx を返さなければならない。それ以外のステータスコードを返した場合、通知は失敗したとみなされる (リダイレクトも機能しない)。2xx のレスポンスはあくまで正常に通知を受け取ったことを表すのみであり、通知の内容が正しいことを示すものではない。\u003c/p\u003e\n\u003cp\u003eリクエストには、RFC5988 に規定される \u003ca href=https://tools.ietf.org/html/rfc5988 target='_blank' rel='noopener'\u003eLink Header\u003c/a\u003e が付与される。\u003ccode\u003erel=hub\u003c/code\u003e には Hub の URL を、\u003ccode\u003erel=self\u003c/code\u003e には Topic の URL が指定される。\u003c/p\u003e\n\u003cp\u003e参照: \u003ca href=https://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.4.html#contentdistribution target='_blank' rel='noopener'\u003e7. Content Distribution\u003c/a\u003e\u003c/p\u003e\n\u003ch3\u003e検証可能な更新の通知\u003c/h3\u003e\n\u003cp\u003eSubscription Request に \u003ccode\u003ehub.secret\u003c/code\u003e を含めた場合、Hub はペイロードの HMAC 署名をヘッダに付与する。署名は 40 バイトの 16 進数表示の SHA-1 である。ヘッダの形式は次のようになる。\u003c/p\u003e\n\u003cpre\u003e\n\u003ccode\u003eX-Hub-Signature: sha1=\u003csignature\u003e\u003c/code\u003e\n\u003c/pre\u003e\u003cp\u003eこれにより、通知の内容が第三者に偽造されたものではないことを確認できる。\u003c/p\u003e\n\u003cp\u003e\u003ca href=https://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.4.html#authednotify target='_blank' rel='noopener'\u003e8. Authenticated Content Distribution\u003c/a\u003e\u003c/p\u003e\n\u003ch2\u003ePubSubHubbub Core 0.3 による追加事項\u003c/h2\u003e\n\u003ch3\u003eメッセージの形式\u003c/h3\u003e\n\u003cp\u003e更新の通知は \u003ca href=https://tools.ietf.org/html/rfc4287 target='_blank' rel='noopener'\u003eAtom\u003c/a\u003e あるいは \u003ca href=https://www.rssboard.org/rss-specification target='_blank' rel='noopener'\u003eRSS\u003c/a\u003e の形式である。\u003c/p\u003e\n\u003cp\u003e参照: \u003ca href=https://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.3.html#anchor4 target='_blank' rel='noopener'\u003e4.  Atom Details\u003c/a\u003e\u003c/p\u003e\n\u003ch3\u003eSubscription Request\u003c/h3\u003e\n\u003cp\u003e以下のパラメータが追加される。\u003c/p\u003e\n\u003cdl\u003e\n    \u003cdt\u003ehub.verify\u003c/dt\u003e\n    \u003cdd\u003eREQUIRED. Subscriber が Subscription を確認する方法を指定する。\u003ccode\u003esync\u003c/code\u003e あるいは \u003ccode\u003easync\u003c/code\u003e のいずれの値をとる。\u003c/dd\u003e\n    \u003cdt\u003ehub.verify_token\u003c/dt\u003e\n    \u003cdd\u003eOPTIONAL. 指定した場合、Hub はこの値を Verification Request のクエリパラメータに付与する。\u003c/dd\u003e\n\u003c/dl\u003e\n\n\u003cp\u003e参考: \u003ca href=https://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.3.html#anchor5 target='_blank' rel='noopener'\u003e6.1.  Subscriber Sends Subscription Request\u003c/a\u003e\u003c/p\u003e\n\u003ch3\u003eVerification Request\u003c/h3\u003e\n\u003cp\u003e以下のクエリパラメータが追加される。\u003c/p\u003e\n\u003cdl\u003e\n    \u003cdt\u003ehub.verify_token\u003c/dt\u003e\n    \u003cdd\u003eOPTIONAL. Subscription Request に指定した値をそのまま含む。\u003c/dd\u003e\n\u003c/dl\u003e\n\n\u003cp\u003e以下のパラメータが変更される。\u003c/p\u003e\n\u003cdl\u003e\n    \u003cdt\u003ehub.lease_seconds\u003c/dt\u003e\n    \u003cdd\u003eOPTIONAL/REQUIRED. 値が含まれていた場合の挙動は PubSubHubbub Core 0.4 と同一である。値が含まれない場合、後述するように Subscription の更新の挙動が変わる。\u003c/dd\u003e\n\u003c/dl\u003e\n\n\u003cp\u003e参照: \u003ca href=https://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.3.html#verifysub target='_blank' rel='noopener'\u003e6.2.  Hub Verifies Intent of the Subscriber\u003c/a\u003e\u003c/p\u003e\n\u003ch3\u003e自動的な Subscription の更新\u003c/h3\u003e\n\u003cp\u003e注意: pubsubhubbub.appspot.com では非対応である。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003ehub.lease_seconds\u003c/code\u003e が経過する前に、Hub は自動的に Subscription の確認を行う。\u003c/p\u003e\n\u003cp\u003e参照: \u003ca href=https://pubsubhubbub.github.io/PubSubHubbub/pubsubhubbub-core-0.3.html#autorefresh target='_blank' rel='noopener'\u003e6.3 Automatic Subscription Refresh\u003c/a\u003e\u003c/p\u003e\n\u003ch2\u003epubsubhubbub.appspot.com の挙動\u003c/h2\u003e\n\u003cp\u003e筆者が自分の環境で確認したものである。仕様に定められた挙動ではないため、将来的に変更される可能性もある。\u003c/p\u003e\n\u003ch3\u003eSubscription Request の宛先\u003c/h3\u003e\n\u003cp\u003e送信先は \u003ccode\u003ehttps://pubsubhubbub.appspot.com/subscribe\u003c/code\u003e である。\u003c/p\u003e\n\u003ch3\u003eSubscription Response のステータスコード\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003ehub.verify\u003c/code\u003e が \u003ccode\u003esync\u003c/code\u003e の場合、正常に Subscription Request が受理されたときは 204 No Content を返す。\u003c/p\u003e\n\u003ch3\u003ePermanent Subscription の非対応\u003c/h3\u003e\n\u003cp\u003ePubSubHubbub Core 0.3 の 6.3 Automatic Subscription Refresh には対応しない。Subscriber は hub.lease_seconds が経過する前に再び Subscription Request を行う必要がある。\u003c/p\u003e\n\u003ch2\u003e補足・考察\u003c/h2\u003e\n\u003cp\u003epubsubhubbub.appspot.com は PubSubHubbub Core 0.4 に加えて PubSubHubbub Core 0.3 も参照するが、Permanent Subscription には非対応であるため、実用上は \u003ccode\u003ehub.verify_token\u003c/code\u003e が追加されることにだけ注意すれば良いと思われる。大抵の場合は \u003ccode\u003ehub.verify\u003c/code\u003e を \u003ccode\u003esync\u003c/code\u003e として問題ないであろう。\u003c/p\u003e\n\u003cp\u003ePubSubHubbub Core 0.3 では更新通知のメッセージ形式が Atom または RSS と規定されているが、PubSubHubbub Core 0.4 および WebSub では撤廃されている。これにより、より汎用性の高いプロトコルを目指したと思われる。\u003c/p\u003e\n\u003cp\u003eまた、新しいバージョンでは \u003ccode\u003ehub.verify_token\u003c/code\u003e も撤廃されている。このプロパティによって Verification Request を検証できるというメリットがあったが、これは Subscriber Callback URL に独自のクエリパラメータを付与することで代替できる。あるいは、第三者によって意図しない Subscription を登録されたとしても、更新通知を処理するかどうかは変わらず Subscriber の判断によるため、仕様から削除されたのかもしれない。\u003c/p\u003e\n\u003cp\u003eAutomatic Subscription Refresh の撤廃は、より簡単な Webhook の登録を目指すという観点からは悪手であろう。一方、PubSubHubbub はそもそも RSS や Atom フィードのリアルタイム化を目指したものであること (\u003ca href=https://ja.wikipedia.org/wiki/WebSub target='_blank' rel='noopener'\u003eWikipedia\u003c/a\u003e を参照のこと) を踏まえれば妥当であるともいえる。もし Subscriber が Subscription の更新を忘れてしまったとしても、最新の更新情報は元のリソースを参照することで簡単に取得できるからである。\u003c/p\u003e\n\u003ch2\u003e経緯 (余談)\u003c/h2\u003e\n\u003cp\u003eYouTube Data API v3 について調べていたのだが、Search: list (100 Units/Request) をむやみに叩くとすぐに制限 (10,000 Units/Day) に達してしまう。特定のチャンネルのアップデートを素早く受け取るために、\u003ca href=https://developers.google.com/youtube/v3/guides/push_notifications target='_blank' rel='noopener'\u003ePubSubHubbub をサポート\u003c/a\u003eしていた。\u003c/p\u003e\n"},"__N_SSG":true},"page":"/entries/[date]/[id]","query":{"date":"2020-05-04","id":"websub"},"buildId":"qodGxex_IjWP7_GgroZ1s","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-e750b8bf0c81a657f011.js"></script><script src="/_next/static/chunks/main-f01cf1dcca173d7f43b1.js" async=""></script><script src="/_next/static/chunks/webpack-ccf5ab034a524403276a.js" async=""></script><script src="/_next/static/chunks/framework.ea5d6f7a7099b14097ba.js" async=""></script><script src="/_next/static/chunks/commons.136473f176143783e714.js" async=""></script><script src="/_next/static/chunks/pages/_app-7826aa35c5692e1bca69.js" async=""></script><script src="/_next/static/chunks/44192d0b83adb4471c56c08528820b1f17270e33.228b4631e982fe3bd0c5.js" async=""></script><script src="/_next/static/chunks/pages/entries/%5Bdate%5D/%5Bid%5D-217160f5fe64bb279c4b.js" async=""></script><script src="/_next/static/qodGxex_IjWP7_GgroZ1s/_buildManifest.js" async=""></script><script src="/_next/static/qodGxex_IjWP7_GgroZ1s/_ssgManifest.js" async=""></script></body></html>