<!DOCTYPE html><html lang="ja"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>ブログを Next.js で作り直した | blog.comame.xyz</title><meta property="og:type" content="article"/><meta property="og:url" content="https://blog.comame.xyz/entries/2020-08-30/renew-blog-nextjs.md"/><meta property="og:title" content="ブログを Next.js で作り直した | blog.comame.xyz"/><meta property="og:site_name" content="blog.comame.xyz"/><meta property="og:description" content=""/><meta name="description" content=""/><meta name="next-head-count" content="9"/><link rel="preload" href="/_next/static/css/75b3a985ae8df8a5857d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/75b3a985ae8df8a5857d.css"/><link rel="preload" href="/_next/static/css/7e552a05a23ef38b9280.css" as="style"/><link rel="stylesheet" href="/_next/static/css/7e552a05a23ef38b9280.css"/><link rel="preload" href="/_next/static/chunks/main-f01cf1dcca173d7f43b1.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-ccf5ab034a524403276a.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.ea5d6f7a7099b14097ba.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.136473f176143783e714.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-7826aa35c5692e1bca69.js" as="script"/><link rel="preload" href="/_next/static/chunks/44192d0b83adb4471c56c08528820b1f17270e33.228b4631e982fe3bd0c5.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/entries/%5Bdate%5D/%5Bid%5D-ddd608bb2bf2fc9bc89e.js" as="script"/></head><body><div id="__next"><header class="header_header__10AWY"><a href="/">blog.comame.xyz</a></header><div class="post"><div class="metadata_metadata__3aUvp"><h1 id="title">ブログを Next.js で作り直した</h1><time id="time">2020-08-30</time><ul class="tag-list_tag-list__1Wf57"><li><a href="/tags/Blog.html">Blog</a></li></ul></div><div class="content_content__3lhGG"><p>このブログを <a href=https://nextjs.org/ target='_blank' rel='noopener'>Next.js</a> で作り直した。以前に動いていたものをほぼ再現できたと思う。</p>
<h2>嬉しくなった点</h2>
<h3>ソースコードが大幅に読みやすくなった</h3>
<p>以前は自作ルーター + 巨大 <a href=https://github.com/comame/blog.comame.xyz/blob/707d9271f0e17eddd231ee7041408566e424bbdc/assets/js/app.js target='_blank' rel='noopener'>app.js</a> で全てを行っていたため、これは何ですかと言いたくなるようなコードになっていた。</p>
<h3>アクセス時に読み込まれる CSS が少し小さくなった</h3>
<p>以前はページごとに 3 つの CSS ファイルに分割し、minify したものを HTML に埋め込んでいた。今は Next.js がうまいことコンポーネント分割してくれている、らしい。</p>
<p>以前はインラインで記述していたためすべてのアクセスでダウンロード量に影響したが、今は <code>&lt;link&gt;</code> タグで埋め込まれているため、初回より後のアクセスでは読み込みが速くなると思われる。ただ、初回アクセスでどちらが速いのかはよく分かっていない。</p>
<h3>GitHub Actions でのビルドが相当速くなった</h3>
<p>以前は Puppeteer を使って静的サイトジェネレーションを行っていたが、それを Next.js がやってくれるようになったおかげで、ビルドが相当高速化した。以前は 1 分以上かかっていたものが、今は 30 秒程度で終わるようになった。</p>
<h3>開発環境でのプレビューが容易になった</h3>
<p><code>npx next dev</code> を叩くだけで容易にプレビューできるようになった。</p>
<h2>私はここで苦しみました</h2>
<h3>SSG をすると、<code>next/link</code> のリンクが機能しない</h3>
<p>これは以前の URL 構造をそのまま保とうとしたことが原因であるため、どちらかといえば私の使い方の問題であろう。Next.js の Dynamic Routing では、各ページの URL に <code>.html</code> の拡張子を付与することはできないため、SSG したときにサイト内リンクが尽くリンク切れを起こす問題が発生した。例えば、SSG 後の URL は <code>/tags/foo.html</code> であるにも関わらず、サイト内リンクの <code>href</code> は <code>/tags/foo</code> のままである、といった具合である。</p>
<p>この問題は Next.js の設定を弄ることで容易に解消できる。<code>next.config.js</code> で <a href=https://nextjs.org/docs/api-reference/next.config.js/trailing-slash target='_blank' rel='noopener'><code>trailingSlash: true</code></a> を設定すればよい。しかし、私のブログの URL 構造を保とうとした場合、これでは過去のリンクがすべてリンク切れを起こしてしまう問題があり、この方法は導入できなかった。</p>
<p>そこで、<code>&lt;Link&gt;</code> をラップし、SSG を行うときは手動で <code>&lt;a&gt;</code> タグを返すようにした。SSG かどうかは環境変数によって判別することとした (<a href=https://nextjs.org/docs/basic-features/environment-variables#exposing-environment-variables-to-the-browser target='_blank' rel='noopener'>NEXT_PUBLIC_ から始まる環境変数はブラウザからも参照できる</a>) 。</p>
<p>参照: <a href=https://github.com/comame/blog.comame.xyz/blob/b7b80220685f6c568bcb9cfedf820db953899123/src/lib/link.tsx target='_blank' rel='noopener'>https://github.com/comame/blog.comame.xyz/blob/b7b80220685f6c568bcb9cfedf820db953899123/src/lib/link.tsx</a></p>
<h3>GitHub Pages でうまいことホストされない</h3>
<p>以前と同様に GitHub Pages でホストしようと思ったところ、なぜか <code>docs/_next/</code> 配下のファイルが 404 を返してしまう問題に遭遇した。これは GitHub Pages に組み込まれている Jekyll が原因であり、<code>_</code> から始まるディレクトリ名を持つディレクトリは配信されないようである。</p>
<p>これを解消するために、GitHub Pages で配信するディレクトリの最上位ディレクトリ (このブログでは <code>&lt;projectroot&gt;/docs/</code>) に `.nojekyll ファイルを置いた。</p>
<p>どうやらこの方法は GitHub のドキュメントには書かれておらず、<a href=https://github.blog/2009-12-29-bypassing-jekyll-on-github-pages/ target='_blank' rel='noopener'>GitHub Blog</a> にしか公式の記事を見つけることができなかった。</p>
</div><div class="share_share__2h1cH"><img alt="共有" src="/icons/share.svg"/><a rel="noopener" target="_blank" title="Twitter で共有" href="https://twitter.com/intent/tweet?text=%E3%83%96%E3%83%AD%E3%82%B0%E3%82%92%20Next.js%20%E3%81%A7%E4%BD%9C%E3%82%8A%E7%9B%B4%E3%81%97%E3%81%9F%0a&amp;url=https%3A%2F%2Fblog.comame.xyz%2Fentries%2F2020-08-30%2Frenew-blog-nextjs.html&amp;related=comameito"><img alt="Twitter で共有" src="/icons/twitter_logo.svg"/></a><a rel="noopener" target="_blank" title="Facebook で共有" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fblog.comame.xyz%2Fentries%2F2020-08-30%2Frenew-blog-nextjs.html"><img alt="Facebook で共有" src="/icons/facebook_logo.svg"/></a><a title="URL をコピー" id="url-copy"><img alt="URL をコピー" src="/icons/link.svg"/></a><script async="" src="/js/url-copy.js"></script></div></div><footer class="footer_footer__cDy4s"><small><a href="https://github.com/comame/blog.comame.xyz" target="_blank" rel="noopener"><img alt="GitHub Actions build status" id="build-status" src="https://github.com/comame/blog.comame.xyz/workflows/Build/badge.svg?event=push"/></a></small><small><span>Copyright 2020 <a href="https://comame.xyz">comame</a></span><span><a target="_blank" rel="noopener" href="https://github.com/comame/blog.comame.xyz/blob/master/archives/2020/renew-blog-nextjs.md">source</a></span><span><a target="_blank" rel="noopener" href="https://github.com/comame/blog.comame.xyz/commits/master/archives/2020/renew-blog-nextjs.md">history</a></span><span><a href="/feed.xml">Feed</a></span></small></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"entry":{"entry":"renew-blog-nextjs","title":"ブログを Next.js で作り直した","date":"2020-08-30","tags":["Blog"],"type":"md"},"text":"\u003cp\u003eこのブログを \u003ca href=https://nextjs.org/ target='_blank' rel='noopener'\u003eNext.js\u003c/a\u003e で作り直した。以前に動いていたものをほぼ再現できたと思う。\u003c/p\u003e\n\u003ch2\u003e嬉しくなった点\u003c/h2\u003e\n\u003ch3\u003eソースコードが大幅に読みやすくなった\u003c/h3\u003e\n\u003cp\u003e以前は自作ルーター + 巨大 \u003ca href=https://github.com/comame/blog.comame.xyz/blob/707d9271f0e17eddd231ee7041408566e424bbdc/assets/js/app.js target='_blank' rel='noopener'\u003eapp.js\u003c/a\u003e で全てを行っていたため、これは何ですかと言いたくなるようなコードになっていた。\u003c/p\u003e\n\u003ch3\u003eアクセス時に読み込まれる CSS が少し小さくなった\u003c/h3\u003e\n\u003cp\u003e以前はページごとに 3 つの CSS ファイルに分割し、minify したものを HTML に埋め込んでいた。今は Next.js がうまいことコンポーネント分割してくれている、らしい。\u003c/p\u003e\n\u003cp\u003e以前はインラインで記述していたためすべてのアクセスでダウンロード量に影響したが、今は \u003ccode\u003e\u0026lt;link\u0026gt;\u003c/code\u003e タグで埋め込まれているため、初回より後のアクセスでは読み込みが速くなると思われる。ただ、初回アクセスでどちらが速いのかはよく分かっていない。\u003c/p\u003e\n\u003ch3\u003eGitHub Actions でのビルドが相当速くなった\u003c/h3\u003e\n\u003cp\u003e以前は Puppeteer を使って静的サイトジェネレーションを行っていたが、それを Next.js がやってくれるようになったおかげで、ビルドが相当高速化した。以前は 1 分以上かかっていたものが、今は 30 秒程度で終わるようになった。\u003c/p\u003e\n\u003ch3\u003e開発環境でのプレビューが容易になった\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003enpx next dev\u003c/code\u003e を叩くだけで容易にプレビューできるようになった。\u003c/p\u003e\n\u003ch2\u003e私はここで苦しみました\u003c/h2\u003e\n\u003ch3\u003eSSG をすると、\u003ccode\u003enext/link\u003c/code\u003e のリンクが機能しない\u003c/h3\u003e\n\u003cp\u003eこれは以前の URL 構造をそのまま保とうとしたことが原因であるため、どちらかといえば私の使い方の問題であろう。Next.js の Dynamic Routing では、各ページの URL に \u003ccode\u003e.html\u003c/code\u003e の拡張子を付与することはできないため、SSG したときにサイト内リンクが尽くリンク切れを起こす問題が発生した。例えば、SSG 後の URL は \u003ccode\u003e/tags/foo.html\u003c/code\u003e であるにも関わらず、サイト内リンクの \u003ccode\u003ehref\u003c/code\u003e は \u003ccode\u003e/tags/foo\u003c/code\u003e のままである、といった具合である。\u003c/p\u003e\n\u003cp\u003eこの問題は Next.js の設定を弄ることで容易に解消できる。\u003ccode\u003enext.config.js\u003c/code\u003e で \u003ca href=https://nextjs.org/docs/api-reference/next.config.js/trailing-slash target='_blank' rel='noopener'\u003e\u003ccode\u003etrailingSlash: true\u003c/code\u003e\u003c/a\u003e を設定すればよい。しかし、私のブログの URL 構造を保とうとした場合、これでは過去のリンクがすべてリンク切れを起こしてしまう問題があり、この方法は導入できなかった。\u003c/p\u003e\n\u003cp\u003eそこで、\u003ccode\u003e\u0026lt;Link\u0026gt;\u003c/code\u003e をラップし、SSG を行うときは手動で \u003ccode\u003e\u0026lt;a\u0026gt;\u003c/code\u003e タグを返すようにした。SSG かどうかは環境変数によって判別することとした (\u003ca href=https://nextjs.org/docs/basic-features/environment-variables#exposing-environment-variables-to-the-browser target='_blank' rel='noopener'\u003eNEXT_PUBLIC_ から始まる環境変数はブラウザからも参照できる\u003c/a\u003e) 。\u003c/p\u003e\n\u003cp\u003e参照: \u003ca href=https://github.com/comame/blog.comame.xyz/blob/b7b80220685f6c568bcb9cfedf820db953899123/src/lib/link.tsx target='_blank' rel='noopener'\u003ehttps://github.com/comame/blog.comame.xyz/blob/b7b80220685f6c568bcb9cfedf820db953899123/src/lib/link.tsx\u003c/a\u003e\u003c/p\u003e\n\u003ch3\u003eGitHub Pages でうまいことホストされない\u003c/h3\u003e\n\u003cp\u003e以前と同様に GitHub Pages でホストしようと思ったところ、なぜか \u003ccode\u003edocs/_next/\u003c/code\u003e 配下のファイルが 404 を返してしまう問題に遭遇した。これは GitHub Pages に組み込まれている Jekyll が原因であり、\u003ccode\u003e_\u003c/code\u003e から始まるディレクトリ名を持つディレクトリは配信されないようである。\u003c/p\u003e\n\u003cp\u003eこれを解消するために、GitHub Pages で配信するディレクトリの最上位ディレクトリ (このブログでは \u003ccode\u003e\u0026lt;projectroot\u0026gt;/docs/\u003c/code\u003e) に `.nojekyll ファイルを置いた。\u003c/p\u003e\n\u003cp\u003eどうやらこの方法は GitHub のドキュメントには書かれておらず、\u003ca href=https://github.blog/2009-12-29-bypassing-jekyll-on-github-pages/ target='_blank' rel='noopener'\u003eGitHub Blog\u003c/a\u003e にしか公式の記事を見つけることができなかった。\u003c/p\u003e\n"},"__N_SSG":true},"page":"/entries/[date]/[id]","query":{"date":"2020-08-30","id":"renew-blog-nextjs"},"buildId":"rddQuo77vSmkKOsPP-zxE","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-e750b8bf0c81a657f011.js"></script><script src="/_next/static/chunks/main-f01cf1dcca173d7f43b1.js" async=""></script><script src="/_next/static/chunks/webpack-ccf5ab034a524403276a.js" async=""></script><script src="/_next/static/chunks/framework.ea5d6f7a7099b14097ba.js" async=""></script><script src="/_next/static/chunks/commons.136473f176143783e714.js" async=""></script><script src="/_next/static/chunks/pages/_app-7826aa35c5692e1bca69.js" async=""></script><script src="/_next/static/chunks/44192d0b83adb4471c56c08528820b1f17270e33.228b4631e982fe3bd0c5.js" async=""></script><script src="/_next/static/chunks/pages/entries/%5Bdate%5D/%5Bid%5D-ddd608bb2bf2fc9bc89e.js" async=""></script><script src="/_next/static/rddQuo77vSmkKOsPP-zxE/_buildManifest.js" async=""></script><script src="/_next/static/rddQuo77vSmkKOsPP-zxE/_ssgManifest.js" async=""></script></body></html>