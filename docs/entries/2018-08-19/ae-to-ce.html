<!DOCTYPE html><html lang="ja"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>App Engine から Compute Engine に移行 | blog.comame.xyz</title><meta property="og:type" content="article"/><meta property="og:url" content="https://blog.comame.xyz/entries/2018-08-19/ae-to-ce.html"/><meta property="og:title" content="App Engine から Compute Engine に移行 | blog.comame.xyz"/><meta property="og:site_name" content="blog.comame.xyz"/><meta property="og:description" content=""/><meta name="description" content=""/><meta name="next-head-count" content="9"/><link rel="preload" href="/_next/static/css/75b3a985ae8df8a5857d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/75b3a985ae8df8a5857d.css"/><link rel="preload" href="/_next/static/css/7e552a05a23ef38b9280.css" as="style"/><link rel="stylesheet" href="/_next/static/css/7e552a05a23ef38b9280.css"/><link rel="preload" href="/_next/static/chunks/main-f01cf1dcca173d7f43b1.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-ccf5ab034a524403276a.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.ea5d6f7a7099b14097ba.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.136473f176143783e714.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-7826aa35c5692e1bca69.js" as="script"/><link rel="preload" href="/_next/static/chunks/44192d0b83adb4471c56c08528820b1f17270e33.228b4631e982fe3bd0c5.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/entries/%5Bdate%5D/%5Bid%5D-17125ab0ca7d7e77889a.js" as="script"/></head><body><div id="__next"><header class="header_header__10AWY"><a href="/">blog.comame.xyz</a></header><div class="post"><div class="metadata_metadata__3aUvp"><h1 id="title">App Engine から Compute Engine に移行</h1><time id="time">2018-08-19</time><ul class="tag-list_tag-list__1Wf57"><li><a href="/tags/Web.html">Web</a></li><li><a href="/tags/server.html">server</a></li></ul></div><div class="content_content__3lhGG"><p>今まで Google App Engine Node.js Standard Environment (GAE/Node.js SE) で動かしていた <a href="https://comame.xyz/" target="_blank" rel="noopener">comame.xyz</a> を、Compute Engine に移しました。</p><h2>理由</h2><p>Nginx をいじってたら楽しくなってきちゃったから。</p><h2>感想</h2><ul>    <li>予想を遥かに上回るレベルで楽だった</li>
    <li>環境依存するコードをほぼ書かなくて済むので、GAE/Node.js SE はいいぞ</li>
    <li>Nginx 楽しい</li>
    <li>Certbot (Let's Encrypt) すごい楽</li>
</ul><h2>環境</h2><ul>    <li>Google Compute Engine / f1-micro</li>
    <li>Ubuntu 18.04</li>
    <li>Nginx, Node.js</li>
</ul><h2>手順</h2><ol>    <li>GAE で動いていたコードを、Compute Engine に移す。</li>
    <li>Nginx の設定ファイルにバーチャルホストの設定を追加する。</li>
    <li>Node.js を systemd のサービスとして設定する。</li>
    <li>Nginx の設定ファイルに Node.js へリクエスト回す処理を追記する。</li>
    <li>Certbot で電子証明書を取得する。</li>
</ol><h3>コードを移す</h3><p>GAE/Node.js SE は GAE に依存する部分が少ないため、ほぼそのままコードを移すだけで完了。静的なファイルを配信する部分だけ、Nginx 側に処理を回すためにコードを削除。</p><h3>Nginx の設定をする</h3><p>こんな感じ。80 版ポートの方は省略。</p><pre><code># /etc/nginx/sites-enabled/comame.xyz

server {
    server_name comame.xyz;
    listen 443 http2 ssl;

    # ....
}
</code></pre><h3>systemd に Node.js をサービスとして登録する</h3><p>多分落ちたときに自動再起動してくれると思う。まだ落ちてないからわからん。</p><pre><code># /etc/systemd/system/nodejs.service

[Unit]
Description=Node.js server

[Service]
WorkingDirectory=/home/hoge
Type=simple
ExecStart=/usr/bin/node /path/to/script.js
Restart=always
StandardOutput=syslog
StandardError=syslog
SyslogIdentifier=node
User=hoge
Group=hoge

[Install]
WantedBy=multi-user.target</code></pre>
<p><code>$ systemctl start nodejs.service</code> でサービスを起動。<code>$ systemctl enable nodejs.service</code> で OS の起動時にサービスを起動するよう設定。</p>
<h3>Nginx から Node.js にリクエストを回す</h3><pre><code># /etc/nginx/sites-enabled/comame.xyz

upstream node {
    # Node.js は 3000 番ポートで動かすことにした
    server 127.0.0.1:3000;
}

server {
    # ...
    location / {
        proxy_pass http://node;
    }
}</code></pre><h3>Certbot で電子証明書を取得</h3><p>コマンド叩くだけで電子証明書が取得できるの、本当にすごいよね。あとは Nginx 側で証明書のパスを指定するだけ。</p><p><code>$ certbot certonly --nginx<code></code></code></p>
</div><div class="share_share__2h1cH"><img alt="共有" src="/icons/share.svg"/><a rel="noopener" target="_blank" title="Twitter で共有" href="https://twitter.com/intent/tweet?text=App%20Engine%20%E3%81%8B%E3%82%89%20Compute%20Engine%20%E3%81%AB%E7%A7%BB%E8%A1%8C%0a&amp;url=https%3A%2F%2Fblog.comame.xyz%2Fentries%2F2018-08-19%2Fae-to-ce.html&amp;related=comameito"><img alt="Twitter で共有" src="/icons/twitter_logo.svg"/></a><a rel="noopener" target="_blank" title="Facebook で共有" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fblog.comame.xyz%2Fentries%2F2018-08-19%2Fae-to-ce.html"><img alt="Facebook で共有" src="/icons/facebook_logo.svg"/></a><a title="URL をコピー" id="url-copy"><img alt="URL をコピー" src="/icons/link.svg"/></a><script async="" src="/js/url-copy.js"></script></div></div><footer class="footer_footer__cDy4s"><small><a href="https://github.com/comame/blog.comame.xyz" target="_blank" rel="noopener"><img alt="GitHub Actions build status" id="build-status" src="https://github.com/comame/blog.comame.xyz/workflows/Build/badge.svg?event=push"/></a></small><small><span>© <!-- -->2018<!-- --> <a href="https://comame.xyz">comame</a></span><span><a target="_blank" rel="noopener" href="https://github.com/comame/blog.comame.xyz/blob/master/archives/2018/ae-to-ce.html">source</a></span><span><a target="_blank" rel="noopener" href="https://github.com/comame/blog.comame.xyz/commits/master/archives/2018/ae-to-ce.html">history</a></span><span><a href="/feed.xml">Feed</a></span></small></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"entry":{"entry":"ae-to-ce","title":"App Engine から Compute Engine に移行","date":"2018-08-19","tags":["Web","server"],"type":"html"},"text":"\u003cp\u003e今まで Google App Engine Node.js Standard Environment (GAE/Node.js SE) で動かしていた \u003ca href=\"https://comame.xyz/\" target=\"_blank\" rel=\"noopener\"\u003ecomame.xyz\u003c/a\u003e を、Compute Engine に移しました。\u003c/p\u003e\u003ch2\u003e理由\u003c/h2\u003e\u003cp\u003eNginx をいじってたら楽しくなってきちゃったから。\u003c/p\u003e\u003ch2\u003e感想\u003c/h2\u003e\u003cul\u003e    \u003cli\u003e予想を遥かに上回るレベルで楽だった\u003c/li\u003e\n    \u003cli\u003e環境依存するコードをほぼ書かなくて済むので、GAE/Node.js SE はいいぞ\u003c/li\u003e\n    \u003cli\u003eNginx 楽しい\u003c/li\u003e\n    \u003cli\u003eCertbot (Let's Encrypt) すごい楽\u003c/li\u003e\n\u003c/ul\u003e\u003ch2\u003e環境\u003c/h2\u003e\u003cul\u003e    \u003cli\u003eGoogle Compute Engine / f1-micro\u003c/li\u003e\n    \u003cli\u003eUbuntu 18.04\u003c/li\u003e\n    \u003cli\u003eNginx, Node.js\u003c/li\u003e\n\u003c/ul\u003e\u003ch2\u003e手順\u003c/h2\u003e\u003col\u003e    \u003cli\u003eGAE で動いていたコードを、Compute Engine に移す。\u003c/li\u003e\n    \u003cli\u003eNginx の設定ファイルにバーチャルホストの設定を追加する。\u003c/li\u003e\n    \u003cli\u003eNode.js を systemd のサービスとして設定する。\u003c/li\u003e\n    \u003cli\u003eNginx の設定ファイルに Node.js へリクエスト回す処理を追記する。\u003c/li\u003e\n    \u003cli\u003eCertbot で電子証明書を取得する。\u003c/li\u003e\n\u003c/ol\u003e\u003ch3\u003eコードを移す\u003c/h3\u003e\u003cp\u003eGAE/Node.js SE は GAE に依存する部分が少ないため、ほぼそのままコードを移すだけで完了。静的なファイルを配信する部分だけ、Nginx 側に処理を回すためにコードを削除。\u003c/p\u003e\u003ch3\u003eNginx の設定をする\u003c/h3\u003e\u003cp\u003eこんな感じ。80 版ポートの方は省略。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e# /etc/nginx/sites-enabled/comame.xyz\n\nserver {\n    server_name comame.xyz;\n    listen 443 http2 ssl;\n\n    # ....\n}\n\u003c/code\u003e\u003c/pre\u003e\u003ch3\u003esystemd に Node.js をサービスとして登録する\u003c/h3\u003e\u003cp\u003e多分落ちたときに自動再起動してくれると思う。まだ落ちてないからわからん。\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e# /etc/systemd/system/nodejs.service\n\n[Unit]\nDescription=Node.js server\n\n[Service]\nWorkingDirectory=/home/hoge\nType=simple\nExecStart=/usr/bin/node /path/to/script.js\nRestart=always\nStandardOutput=syslog\nStandardError=syslog\nSyslogIdentifier=node\nUser=hoge\nGroup=hoge\n\n[Install]\nWantedBy=multi-user.target\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003e$ systemctl start nodejs.service\u003c/code\u003e でサービスを起動。\u003ccode\u003e$ systemctl enable nodejs.service\u003c/code\u003e で OS の起動時にサービスを起動するよう設定。\u003c/p\u003e\n\u003ch3\u003eNginx から Node.js にリクエストを回す\u003c/h3\u003e\u003cpre\u003e\u003ccode\u003e# /etc/nginx/sites-enabled/comame.xyz\n\nupstream node {\n    # Node.js は 3000 番ポートで動かすことにした\n    server 127.0.0.1:3000;\n}\n\nserver {\n    # ...\n    location / {\n        proxy_pass http://node;\n    }\n}\u003c/code\u003e\u003c/pre\u003e\u003ch3\u003eCertbot で電子証明書を取得\u003c/h3\u003e\u003cp\u003eコマンド叩くだけで電子証明書が取得できるの、本当にすごいよね。あとは Nginx 側で証明書のパスを指定するだけ。\u003c/p\u003e\u003cp\u003e\u003ccode\u003e$ certbot certonly --nginx\u003ccode\u003e\u003c/code\u003e\u003c/code\u003e\u003c/p\u003e\n"},"__N_SSG":true},"page":"/entries/[date]/[id]","query":{"date":"2018-08-19","id":"ae-to-ce"},"buildId":"PT1Vfms87w4_-a_siQv6u","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-e750b8bf0c81a657f011.js"></script><script src="/_next/static/chunks/main-f01cf1dcca173d7f43b1.js" async=""></script><script src="/_next/static/chunks/webpack-ccf5ab034a524403276a.js" async=""></script><script src="/_next/static/chunks/framework.ea5d6f7a7099b14097ba.js" async=""></script><script src="/_next/static/chunks/commons.136473f176143783e714.js" async=""></script><script src="/_next/static/chunks/pages/_app-7826aa35c5692e1bca69.js" async=""></script><script src="/_next/static/chunks/44192d0b83adb4471c56c08528820b1f17270e33.228b4631e982fe3bd0c5.js" async=""></script><script src="/_next/static/chunks/pages/entries/%5Bdate%5D/%5Bid%5D-17125ab0ca7d7e77889a.js" async=""></script><script src="/_next/static/PT1Vfms87w4_-a_siQv6u/_buildManifest.js" async=""></script><script src="/_next/static/PT1Vfms87w4_-a_siQv6u/_ssgManifest.js" async=""></script></body></html>