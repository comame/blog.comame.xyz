<!DOCTYPE html><html lang="ja"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Docker を使用したGradle のビルドを高速化する | blog.comame.xyz</title><meta property="og:type" content="article"/><meta property="og:url" content="https://blog.comame.xyz/entries/2020-07-02/improve-perforcmance-docker-build-gradle.md"/><meta property="og:title" content="Docker を使用したGradle のビルドを高速化する | blog.comame.xyz"/><meta property="og:site_name" content="blog.comame.xyz"/><meta property="og:description" content=""/><meta name="description" content=""/><meta name="next-head-count" content="9"/><link rel="preload" href="/_next/static/css/75b3a985ae8df8a5857d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/75b3a985ae8df8a5857d.css"/><link rel="preload" href="/_next/static/css/7e552a05a23ef38b9280.css" as="style"/><link rel="stylesheet" href="/_next/static/css/7e552a05a23ef38b9280.css"/><link rel="preload" href="/_next/static/chunks/main-f01cf1dcca173d7f43b1.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-ccf5ab034a524403276a.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.ea5d6f7a7099b14097ba.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.136473f176143783e714.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-7826aa35c5692e1bca69.js" as="script"/><link rel="preload" href="/_next/static/chunks/44192d0b83adb4471c56c08528820b1f17270e33.228b4631e982fe3bd0c5.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/entries/%5Bdate%5D/%5Bid%5D-217160f5fe64bb279c4b.js" as="script"/></head><body><div id="__next"><header class="header_header__10AWY"><a href="/">blog.comame.xyz</a></header><div class="post"><div class="metadata_metadata__3aUvp"><h1 id="title">Docker を使用したGradle のビルドを高速化する</h1><time id="time">2020-07-02</time><ul class="tag-list_tag-list__1Wf57"><li><a href="/tags/Kotlin.html">Kotlin</a></li><li><a href="/tags/note.html">note</a></li></ul></div><div class="content_content__3lhGG"><h2>問題</h2>
<p>Docker で <code>gradle build</code> を実行すると、<code>Starting a Gradle Daemon</code> で 1 分近くかかってしまう。</p>
<h2>解決法</h2>
<p>適当に <code>gradle clean</code> などをあらかじめ実行しておく</p>
<pre>
<code>  # Dockerfile</code>
<code></code>
<code>  FROM gradle</code>
<code></code>
<code>  COPY build.gradle.kt build.gradle.kt</code>
<code></code>
<code class='addition'>+ RUN gradle clean</code>
<code></code>
<code>  COPY src src</code>
<code>  RUN gradle build</code>
<code></code>
</pre><p>Daemon 起動中の出力を見る限り、依存関係の計算やダウンロード、<code>build.gradle.kt</code> のコンパイルに時間がかかっているように見える。一度 <code>gradle clean</code> を実行することによって、<code>gradle build</code> の実行時にはそれらを回避できる。また、<code>src/</code> 以下を変更しただけの場合 <code>RUN gradle clean</code> はキャッシュが利用できるため、初回ビルドより後では高速にビルドできる。</p>
<h2>測定</h2>
<p>簡単な Hello, world! コードで検証した。次に記載するファイル以外は IntelliJ IDEA で生成されたものをそのまま使用した。</p>
<pre>
<code># src/main/kotlin/xyz/comame/test/Main.kt</code>
<code></code>
<code>package xyz.comame.test</code>
<code></code>
<code>fun main() {</code>
<code>    println("Hello,world!")</code>
<code>}</code>
</pre><pre>
<code># Dockerfile</code>
<code></code>
<code>FROM gradle</code>
<code></code>
<code>RUN useradd -m user</code>
<code>USER user</code>
<code>WORKDIR /home/user</code>
<code></code>
<code>COPY gradle.properties gradle.properties</code>
<code>COPY settings.gradle.kts settings.gradle.kts</code>
<code>COPY build.gradle.kts build.gradle.kts</code>
<code></code>
<code>RUN gradle clean</code>
<code></code>
<code>COPY src src</code>
<code>RUN gradle build</code>
</pre><h3>初回ビルド</h3>
<p><code>RUN gradle clean</code> を追加した場合、<code>RUN gradle clean</code> は 49 秒、<code>RUN gradle build</code> は 18 秒かかった。一方、追加しなかった場合、<code>RUN gradle build</code> は 56 秒かかった。</p>
<h3>2 回目のビルド</h3>
<p><code>src/main/kotlin/xyz/comame/test/Main.kt</code> の Hello, world! の文字列を変更して再度ビルドした。<code>docker build</code> のキャッシュは有効である。</p>
<p><code>RUN gradle clean</code> を追加した場合、<code>RUN gradle clean</code> はキャッシュが使用され、<code>RUN gradle build</code> は 18 秒かかった。一方、追加しなかった場合、<code>RUN gradle build</code> は 1 分 3 秒かかった。</p>
<p>複数回測定を繰り返した場合でも、上記とおおむね同様の結果を得られた。</p>
<h2>考慮事項</h2>
<p>Dockerfile に <code>USER root</code> 、<code>WORKDIR /root</code> を指定した場合、<code>RUN gradle build</code> は高速化されなかった。<code>root</code> ユーザーでは効果がないのか、<code>WORKDIR /root</code> の場合に問題があるのか、あるいは他に原因があるのか、今回は未検証である。</p>
</div><div class="share_share__2h1cH"><img alt="共有" src="/icons/share.svg"/><a rel="noopener" target="_blank" title="Twitter で共有" href="https://twitter.com/intent/tweet?text=Docker%20%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%9FGradle%20%E3%81%AE%E3%83%93%E3%83%AB%E3%83%89%E3%82%92%E9%AB%98%E9%80%9F%E5%8C%96%E3%81%99%E3%82%8B%0a&amp;url=https%3A%2F%2Fblog.comame.xyz%2Fentries%2F2020-07-02%2Fimprove-perforcmance-docker-build-gradle.md&amp;related=comameito"><img alt="Twitter で共有" src="/icons/twitter_logo.svg"/></a><a rel="noopener" target="_blank" title="Facebook で共有" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fblog.comame.xyz%2Fentries%2F2020-07-02%2Fimprove-perforcmance-docker-build-gradle.md"><img alt="Facebook で共有" src="/icons/facebook_logo.svg"/></a><a title="URL をコピー" id="url-copy"><img alt="URL をコピー" src="/icons/link.svg"/></a><script async="" src="/js/url-copy.js"></script></div></div><footer class="footer_footer__cDy4s"><small><a href="https://github.com/comame/blog.comame.xyz" target="_blank" rel="noopener"><img alt="GitHub Actions build status" id="build-status" src="https://github.com/comame/blog.comame.xyz/workflows/Build/badge.svg?event=push"/></a></small><small><span>Copyright 2020 <a href="https://comame.xyz">comame</a></span><span><a target="_blank" rel="noopener" href="https://github.com/comame/blog.comame.xyz/blob/master/archives/2020/improve-perforcmance-docker-build-gradle.md">source</a></span><span><a target="_blank" rel="noopener" href="https://github.com/comame/blog.comame.xyz/commits/master/archives/2020/improve-perforcmance-docker-build-gradle.md">history</a></span><span><a href="/feed.xml">Feed</a></span></small></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"entry":{"entry":"improve-perforcmance-docker-build-gradle","title":"Docker を使用したGradle のビルドを高速化する","date":"2020-07-02","tags":["Kotlin","note"],"type":"md"},"text":"\u003ch2\u003e問題\u003c/h2\u003e\n\u003cp\u003eDocker で \u003ccode\u003egradle build\u003c/code\u003e を実行すると、\u003ccode\u003eStarting a Gradle Daemon\u003c/code\u003e で 1 分近くかかってしまう。\u003c/p\u003e\n\u003ch2\u003e解決法\u003c/h2\u003e\n\u003cp\u003e適当に \u003ccode\u003egradle clean\u003c/code\u003e などをあらかじめ実行しておく\u003c/p\u003e\n\u003cpre\u003e\n\u003ccode\u003e  # Dockerfile\u003c/code\u003e\n\u003ccode\u003e\u003c/code\u003e\n\u003ccode\u003e  FROM gradle\u003c/code\u003e\n\u003ccode\u003e\u003c/code\u003e\n\u003ccode\u003e  COPY build.gradle.kt build.gradle.kt\u003c/code\u003e\n\u003ccode\u003e\u003c/code\u003e\n\u003ccode class='addition'\u003e+ RUN gradle clean\u003c/code\u003e\n\u003ccode\u003e\u003c/code\u003e\n\u003ccode\u003e  COPY src src\u003c/code\u003e\n\u003ccode\u003e  RUN gradle build\u003c/code\u003e\n\u003ccode\u003e\u003c/code\u003e\n\u003c/pre\u003e\u003cp\u003eDaemon 起動中の出力を見る限り、依存関係の計算やダウンロード、\u003ccode\u003ebuild.gradle.kt\u003c/code\u003e のコンパイルに時間がかかっているように見える。一度 \u003ccode\u003egradle clean\u003c/code\u003e を実行することによって、\u003ccode\u003egradle build\u003c/code\u003e の実行時にはそれらを回避できる。また、\u003ccode\u003esrc/\u003c/code\u003e 以下を変更しただけの場合 \u003ccode\u003eRUN gradle clean\u003c/code\u003e はキャッシュが利用できるため、初回ビルドより後では高速にビルドできる。\u003c/p\u003e\n\u003ch2\u003e測定\u003c/h2\u003e\n\u003cp\u003e簡単な Hello, world! コードで検証した。次に記載するファイル以外は IntelliJ IDEA で生成されたものをそのまま使用した。\u003c/p\u003e\n\u003cpre\u003e\n\u003ccode\u003e# src/main/kotlin/xyz/comame/test/Main.kt\u003c/code\u003e\n\u003ccode\u003e\u003c/code\u003e\n\u003ccode\u003epackage xyz.comame.test\u003c/code\u003e\n\u003ccode\u003e\u003c/code\u003e\n\u003ccode\u003efun main() {\u003c/code\u003e\n\u003ccode\u003e    println(\"Hello,world!\")\u003c/code\u003e\n\u003ccode\u003e}\u003c/code\u003e\n\u003c/pre\u003e\u003cpre\u003e\n\u003ccode\u003e# Dockerfile\u003c/code\u003e\n\u003ccode\u003e\u003c/code\u003e\n\u003ccode\u003eFROM gradle\u003c/code\u003e\n\u003ccode\u003e\u003c/code\u003e\n\u003ccode\u003eRUN useradd -m user\u003c/code\u003e\n\u003ccode\u003eUSER user\u003c/code\u003e\n\u003ccode\u003eWORKDIR /home/user\u003c/code\u003e\n\u003ccode\u003e\u003c/code\u003e\n\u003ccode\u003eCOPY gradle.properties gradle.properties\u003c/code\u003e\n\u003ccode\u003eCOPY settings.gradle.kts settings.gradle.kts\u003c/code\u003e\n\u003ccode\u003eCOPY build.gradle.kts build.gradle.kts\u003c/code\u003e\n\u003ccode\u003e\u003c/code\u003e\n\u003ccode\u003eRUN gradle clean\u003c/code\u003e\n\u003ccode\u003e\u003c/code\u003e\n\u003ccode\u003eCOPY src src\u003c/code\u003e\n\u003ccode\u003eRUN gradle build\u003c/code\u003e\n\u003c/pre\u003e\u003ch3\u003e初回ビルド\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003eRUN gradle clean\u003c/code\u003e を追加した場合、\u003ccode\u003eRUN gradle clean\u003c/code\u003e は 49 秒、\u003ccode\u003eRUN gradle build\u003c/code\u003e は 18 秒かかった。一方、追加しなかった場合、\u003ccode\u003eRUN gradle build\u003c/code\u003e は 56 秒かかった。\u003c/p\u003e\n\u003ch3\u003e2 回目のビルド\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003esrc/main/kotlin/xyz/comame/test/Main.kt\u003c/code\u003e の Hello, world! の文字列を変更して再度ビルドした。\u003ccode\u003edocker build\u003c/code\u003e のキャッシュは有効である。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eRUN gradle clean\u003c/code\u003e を追加した場合、\u003ccode\u003eRUN gradle clean\u003c/code\u003e はキャッシュが使用され、\u003ccode\u003eRUN gradle build\u003c/code\u003e は 18 秒かかった。一方、追加しなかった場合、\u003ccode\u003eRUN gradle build\u003c/code\u003e は 1 分 3 秒かかった。\u003c/p\u003e\n\u003cp\u003e複数回測定を繰り返した場合でも、上記とおおむね同様の結果を得られた。\u003c/p\u003e\n\u003ch2\u003e考慮事項\u003c/h2\u003e\n\u003cp\u003eDockerfile に \u003ccode\u003eUSER root\u003c/code\u003e 、\u003ccode\u003eWORKDIR /root\u003c/code\u003e を指定した場合、\u003ccode\u003eRUN gradle build\u003c/code\u003e は高速化されなかった。\u003ccode\u003eroot\u003c/code\u003e ユーザーでは効果がないのか、\u003ccode\u003eWORKDIR /root\u003c/code\u003e の場合に問題があるのか、あるいは他に原因があるのか、今回は未検証である。\u003c/p\u003e\n"},"__N_SSG":true},"page":"/entries/[date]/[id]","query":{"date":"2020-07-02","id":"improve-perforcmance-docker-build-gradle"},"buildId":"eaJIyxMmkhvvLZTiksMV8","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-e750b8bf0c81a657f011.js"></script><script src="/_next/static/chunks/main-f01cf1dcca173d7f43b1.js" async=""></script><script src="/_next/static/chunks/webpack-ccf5ab034a524403276a.js" async=""></script><script src="/_next/static/chunks/framework.ea5d6f7a7099b14097ba.js" async=""></script><script src="/_next/static/chunks/commons.136473f176143783e714.js" async=""></script><script src="/_next/static/chunks/pages/_app-7826aa35c5692e1bca69.js" async=""></script><script src="/_next/static/chunks/44192d0b83adb4471c56c08528820b1f17270e33.228b4631e982fe3bd0c5.js" async=""></script><script src="/_next/static/chunks/pages/entries/%5Bdate%5D/%5Bid%5D-217160f5fe64bb279c4b.js" async=""></script><script src="/_next/static/eaJIyxMmkhvvLZTiksMV8/_buildManifest.js" async=""></script><script src="/_next/static/eaJIyxMmkhvvLZTiksMV8/_ssgManifest.js" async=""></script></body></html>